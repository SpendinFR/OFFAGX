{
  "desc_type": "module_emit",
  "name": "self_contract_roundtrip",
  "code": "import os, json, time, hashlib\\nBASE = os.path.join('mem','self_contract')\\nDEF  = os.path.join(BASE,'contract.json')\\nDRIFT = os.path.join(BASE,'drift.log')\\n\\ndef _load(path):\\n    if not os.path.exists(path): return None\\n    with open(path,'r',encoding='utf-8') as f: return json.load(f)\\n\\ndef run(ctx=None):\\n    c = _load(DEF)\\n    if not c:\\n        return {'desc_type':'self_contract_missing','ts':time.time()}\\n    streams = (ctx or {}).get('streams') or []\\n    # ce qu on voit reellement\\n    real_cortex = [s for s in streams if s.startswith('module:') and 'cortex' in s]\\n    declared = set(c.get('cortex') or [])\\n    actual   = set(real_cortex)\\n    missing  = list(declared - actual)\\n    extras   = list(actual - declared)\\n    drift = {\\n        'desc_type': 'self_contract_drift',\\n        'ts': time.time(),\\n        'missing_cortex': missing,\\n        'extra_cortex': extras\\n    }\\n    if missing or extras:\\n        os.makedirs(BASE, exist_ok=True)\\n        with open(DRIFT,'a',encoding='utf-8') as f: f.write(json.dumps(drift,ensure_ascii=False)+'\\\\n')\\n    return drift"
}
