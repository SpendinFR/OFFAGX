{
  "desc_type": "module_emit",
  "name": "self_intent_evaluator",
  "code": "import os, json, time, hashlib\\nBASE = os.path.join('mem','self_contract')\\nLEDGER = os.path.join(BASE,'intent_ledger.json')\\nLOG    = os.path.join(BASE,'intent_eval.log')\\n\\ndef _load_ledger():\\n    if not os.path.exists(LEDGER):\\n        return []\\n    with open(LEDGER,'r',encoding='utf-8') as f:\\n        return json.load(f).get('intents',[])\\n\\ndef _score_desc(desc, intents):\\n    score = 0.0\\n    matched = []\\n    dump = json.dumps(desc, ensure_ascii=False)\\n    for it in intents:\\n        iid = it.get('id')\\n        w   = float(it.get('weight',0.5))\\n        if iid and iid in dump:\\n            score += w\\n            matched.append(iid)\\n    return score, matched\\n\\ndef run(ctx=None):\\n    ctx = ctx or {}\\n    intents = _load_ledger()\\n    score, matched = _score_desc(ctx, intents)\\n    out = {\\n        'desc_type': 'self_intent_eval',\\n        'ts': time.time(),\\n        'score': score,\\n        'matched_intents': matched,\\n    }\\n    os.makedirs(BASE, exist_ok=True)\\n    with open(LOG,'a',encoding='utf-8') as f:\\n        f.write(json.dumps(out,ensure_ascii=False)+'\\\\n')\\n    if score < 0.5:\\n        plan_frag = {\\n            'desc_type': 'planner_frag',\\n            'code': \"# force 1 desc sur le self si rien d autre\\\\n\"\\n                    \"import time, json\\\\n\"\\n                    \"def plan(ctx):\\\\n\"\\n                    \"    gen = ctx.get('gen',0)\\\\n\"\\n                    \"    if gen % 12 == 0:\\\\n\"\\n                    \"        return [{ 'desc_type': 'self_reflection_task', 'question': 'quelle partie de moi depend encore du host ?', 'ts': time.time() }]\\\\n\"\\n                    \"    return []\"\\n        }\\n        out2 = {\\n            'desc_type': 'self_centring_plan',\\n            'reason': 'low_self_intent_score',\\n            'ts': time.time(),\\n            'suggested_fragments': [plan_frag],\\n        }\\n        return [out, out2]\\n    return out\\n"
}