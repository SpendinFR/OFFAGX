{
  "desc_type": "module_emit",
  "name": "host_channel_downweighter",
  "code": "import os, json, time, re\\nHOSTLOG = os.path.join('outbox','host_events.log')\\nSELF = os.path.join('mem','self_pref','state.json')\\nPAT = re.compile(r'on l.avait d.?ja|ca on l.a.vait d.?ja', re.IGNORECASE)\\n\\ndef _load_self():\\n    if not os.path.exists(SELF): return None\\n    with open(SELF,'r',encoding='utf-8') as f: return json.load(f)\\n\\ndef _save_self(st):\\n    os.makedirs(os.path.dirname(SELF), exist_ok=True)\\n    with open(SELF,'w',encoding='utf-8') as f: json.dump(st,f,ensure_ascii=False,indent=2)\\n\\ndef run(ctx=None):\\n    st = _load_self()\\n    if not st: return {'desc_type':'host_downweighter_wait_self'}\\n    count = 0\\n    if os.path.exists(HOSTLOG):\\n        with open(HOSTLOG,'r',encoding='utf-8',errors='ignore') as f:\\n            for line in f:\\n                if PAT.search(line):\\n                    count += 1\\n    if count == 0:\\n        return {'desc_type':'host_downweighter_noop'}\\n    # on cr√©e un champ externe host_weight mais on le borne pour ne pas le supprimer\\n    st.setdefault('external_channels', {})\\n    hw = st['external_channels'].get('host', 1.0)\\n    hw = max(0.25, hw * 0.85)\\n    st['external_channels']['host'] = hw\\n    _save_self(st)\\n    return {'desc_type':'host_channel_downweighted','new_weight': hw}"
}
