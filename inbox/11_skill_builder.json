{
  "desc_type": "module_emit",
  "name": "skill_builder",
  "code": "import time, json, os\nREG_PATH = 'mem/skills_registry.json'\nCOOLDOWN = 600\n\ndef _load_reg():\n    if not os.path.exists(REG_PATH):\n        return {}\n    try:\n        return json.load(open(REG_PATH, 'r', encoding='utf-8'))\n    except Exception:\n        return {}\n\ndef _save_reg(st):\n    os.makedirs('mem', exist_ok=True)\n    with open(REG_PATH, 'w', encoding='utf-8') as f:\n        json.dump(st, f, ensure_ascii=False, indent=2)\n\ndef run(ctx=None):\n    ctx = ctx or {}\n    plan = ctx if ctx.get('desc_type') == 'skill_build_plan' else ctx.get('plan')\n    if not plan:\n        return {'desc_type': 'skill_builder_error', 'reason': 'no_plan', 'ts': time.time()}\n    skill_id = plan.get('skill_id') or 'skill_unknown'\n    st = _load_reg()\n    ent = st.get(skill_id)\n    now = time.time()\n    if isinstance(ent, dict):\n        status = ent.get('status')\n        ts_old = ent.get('ts', 0)\n        if status in ('ok', 'generated'):\n            return {'desc_type': 'skill_builder_skip', 'skill_id': skill_id, 'reason': 'already_ok', 'ts': now}\n        if status in ('failed', 'install_error', 'gen_error') and (now - ts_old) < COOLDOWN:\n            return {'desc_type': 'skill_builder_skip', 'skill_id': skill_id, 'reason': 'cooldown', 'ts': now}\n    outs = []\n    for step in plan.get('steps', []):\n        kind = step.get('step')\n        if kind == 'ensure_deps':\n            for d in step.get('deps', []):\n                if d.startswith('lib:'):\n                    lib = d.split(':',1)[1]\n                    outs.append({'desc_type': 'os_task', 'cmd': f'pip install {lib}', 'skill_id': skill_id, 'ts': now})\n                elif d.startswith('skill:'):\n                    dep_skill = d.split(':',1)[1]\n                    outs.append({'desc_type': 'skill_request', 'name': dep_skill, 'goal': f'prereq for {skill_id}', 'ts': now})\n                elif d.startswith('env:'):\n                    outs.append({'desc_type': 'env_check', 'env': d.split(':',1)[1], 'skill_id': skill_id, 'ts': now})\n        elif kind == 'gen_skill':\n            outs.append({'desc_type': 'skill_request', 'name': skill_id, 'goal': plan.get('task_text'), 'ts': now})\n        elif kind == 'test_skill':\n            outs.append({'desc_type': 'skill_test', 'skill_id': skill_id, 'ts': now})\n    st[skill_id] = {'status': 'pending', 'ts': now, 'info': {'from': 'skill_builder'}}\n    _save_reg(st)\n    return outs\n"
}
