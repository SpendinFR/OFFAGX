{
  "desc_type": "module_emit",
  "name": "stagnation_sensor",
  "code": "import os, json, time, math\\nLOG = 'outbox/tri_eval.log'\\nWINDOW = 25\\nTHRESH = 0.12  # sinon on consid√®re plat\\n\\ndef _tail(path, n):\\n    if not os.path.exists(path): return []\\n    with open(path, 'r', encoding='utf-8') as f:\\n        lines = f.readlines()\\n    return lines[-n:]\\n\\ndef run(ctx=None):\\n    lines = _tail(LOG, WINDOW)\\n    if not lines:\\n        return {'desc_type':'stagnation_sensor_idle'}\\n    Hs, Ss, Ms = [], [], []\\n    for ln in lines:\\n        try:\\n            ev = json.loads(ln)\\n        except Exception:\\n            continue\\n        Hs.append(ev.get('H',0)); Ss.append(ev.get('S',0)); Ms.append(ev.get('M',0))\\n    def _var(xs):\\n        if not xs: return 0.0\\n        m = sum(xs)/len(xs)\\n        return sum((x-m)**2 for x in xs)/len(xs)\\n    vH, vS, vM = _var(Hs), _var(Ss), _var(Ms)\\n    flat = (vH < THRESH and vS < THRESH and vM < THRESH)\\n    if not flat:\\n        return {'desc_type':'stagnation_sensor_ok','vH':vH,'vS':vS,'vM':vM}\\n    return {\\n        'desc_type': 'stagnation_event',\\n        'vH': vH, 'vS': vS, 'vM': vM,\\n        'window': len(Hs),\\n        'ts': time.time()\\n    }"
}
